<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="Potree Viewer with CKAN Integration">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer - {{ resource.name if resource else 'CKAN Integration' }}</title>

	<link rel="stylesheet" type="text/css" href="/potree/build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="/potree/libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="/potree/libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="/potree/libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="/potree/libs/jstree/themes/mixed/style.css">

	<style>
		.error-container {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: rgba(255, 0, 0, 0.9);
			color: white;
			padding: 30px;
			border-radius: 10px;
			text-align: center;
			font-family: Arial, sans-serif;
			max-width: 500px;
			z-index: 10000;
			box-shadow: 0 4px 20px rgba(0,0,0,0.3);
		}
		.error-title {
			font-size: 24px;
			font-weight: bold;
			margin-bottom: 15px;
		}
		.error-message {
			font-size: 16px;
			margin-bottom: 20px;
			line-height: 1.4;
		}
		.error-details {
			background: rgba(0,0,0,0.3);
			padding: 10px;
			border-radius: 5px;
			margin: 15px 0;
			font-family: monospace;
			font-size: 14px;
			text-align: left;
		}
		.retry-button {
			background: white;
			color: red;
			border: none;
			padding: 10px 20px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 16px;
			margin: 5px;
		}
		.retry-button:hover {
			background: #f0f0f0;
		}
		.loading-container {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: rgba(0, 0, 0, 0.8);
			color: white;
			padding: 30px;
			border-radius: 10px;
			text-align: center;
			font-family: Arial, sans-serif;
			z-index: 10000;
		}
		.spinner {
			border: 4px solid #f3f3f3;
			border-top: 4px solid #3498db;
			border-radius: 50%;
			width: 50px;
			height: 50px;
			animation: spin 1s linear infinite;
			margin: 0 auto 20px;
		}
		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}
		.resource-info {
			background: rgba(255, 255, 255, 0.9);
			padding: 15px;
			border-radius: 5px;
			margin: 15px 0;
			border-left: 4px solid #3498db;
		}
		.usage-info {
			background: rgba(240, 240, 240, 0.9);
			padding: 15px;
			border-radius: 5px;
			margin: 15px 0;
		}
		.alert {
			padding: 10px 15px;
			margin: 15px 0;
			border-radius: 4px;
		}
		.alert-info {
			background-color: #d9edf7;
			border: 1px solid #bce8f1;
			color: #31708f;
		}
		.save-notification {
			position: absolute;
			top: 80px;
			right: 20px;
			z-index: 10001;
			max-width: 350px;
			padding: 15px;
			border-radius: 5px;
			font-family: Arial, sans-serif;
			box-shadow: 0 4px 8px rgba(0,0,0,0.3);
			transition: opacity 0.3s ease;
		}
		.save-success {
			background: rgba(76, 175, 80, 0.95);
			color: white;
			border-left: 4px solid #4caf50;
		}
		.save-error {
			background: rgba(244, 67, 54, 0.95);
			color: white;
			border-left: 4px solid #f44336;
		}
		.save-progress {
			background: rgba(255, 193, 7, 0.95);
			color: black;
			border-left: 4px solid #ffc107;
		}
		#save-scene-btn:hover {
			background: #005a87 !important;
			transform: translateY(-1px);
		}
		#save-scene-btn:disabled {
			background: #666 !important;
			cursor: not-allowed;
			opacity: 0.6;
		}
	</style>
</head>

<body>
	<script src="/potree/libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="/potree/libs/spectrum/spectrum.js"></script>
	<script src="/potree/libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="/potree/libs/other/BinaryHeap.js"></script>
	<script src="/potree/libs/tween/tween.min.js"></script>
	<script src="/potree/libs/d3/d3.js"></script>
	<script src="/potree/libs/proj4/proj4.js"></script>
	<script src="/potree/libs/openlayers3/ol.js"></script>
	<script src="/potree/libs/i18next/i18next.js"></script>
	<script src="/potree/libs/jstree/jstree.js"></script>
	<script src="/potree/build/potree/potree.js"></script>
	<script src="/potree/libs/plasio/js/laslaz.js"></script>
	<!-- CKAN template data injection -->
	<script>
		window.ckanSceneData = {% if scene_json %}{{ scene_json|safe }}{% else %}null{% endif %};
		window.ckanResourceData = {
			id: "{% if resource %}{{ resource.id }}{% endif %}",
			name: "{% if resource %}{{ resource.name }}{% endif %}",
			url: "{% if resource %}{{ resource.url }}{% endif %}",
			format: "{% if resource %}{{ resource.format }}{% endif %}"
		};
	</script>

	<script type="module">
		// Import JSON5 support
		import JSON5 from '/potree/libs/json5-2.1.3/json5.mjs';
		window.JSON5 = JSON5;
	</script>

	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px;">
		<div id="potree_render_area" style="background-image: url('/potree/build/potree/resources/images/background.jpg');"></div>
		<div id="potree_sidebar_container"></div>

		<!-- Save Button -->
		<div id="save-controls" style="position: absolute; top: 20px; right: 20px; z-index: 1000; display: none;">
			<button id="save-scene-btn" class="btn btn-primary" style="background: #007cba; border: none; color: white; padding: 10px 15px; border-radius: 4px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
				<i class="fa fa-save"></i> Save Scene
			</button>
		</div>
	</div>

	<!-- Loading indicator -->
	<div id="loading-indicator" class="loading-container" style="display: none;">
		<div class="spinner"></div>
		<div>Loading configuration...</div>
	</div>

	<!-- Error display -->
	<div id="error-container" class="error-container" style="display: none;">
		<div class="error-title">Configuration Loading Error</div>
		<div id="error-message" class="error-message"></div>
		<div id="error-details" class="error-details" style="display: none;"></div>
		<button class="retry-button" onclick="retryConfiguration()">Retry</button>
		<button class="retry-button" onclick="loadDefaultView()">Load Default View</button>
		<button class="retry-button" onclick="reportIssue()">Report Issue</button>
	</div>

	<script type="module">
		import * as THREE from "/potree/libs/three.js/build/three.module.js";

		// Global variables
		window.viewer = null;
		let configUrl = null;
		let urlParams = null;

		// Parse CKAN template data and URL parameters for fallback
		function parseParameters() {
			const params = new URLSearchParams(window.location.search);
			return {
				config: params.get('config'),
				pointcloud: params.get('pointcloud'),
				debug: params.get('debug') === 'true',
				ckanData: window.ckanSceneData,
				resourceData: window.ckanResourceData
			};
		}

		// Show loading indicator
		function showLoading() {
			document.getElementById('loading-indicator').style.display = 'block';
			document.getElementById('error-container').style.display = 'none';
		}

		// Hide loading indicator
		function hideLoading() {
			document.getElementById('loading-indicator').style.display = 'none';
		}

		// Show error with detailed information
		function showError(title, message, details = null, showRetry = true) {
			hideLoading();
			const errorContainer = document.getElementById('error-container');
			const errorMessage = document.getElementById('error-message');
			const errorDetails = document.getElementById('error-details');

			document.querySelector('.error-title').textContent = title;
			errorMessage.textContent = message;

			if (details) {
				errorDetails.textContent = details;
				errorDetails.style.display = 'block';
			} else {
				errorDetails.style.display = 'none';
			}

			errorContainer.style.display = 'block';
		}

		// Hide error display
		function hideError() {
			document.getElementById('error-container').style.display = 'none';
		}

		// Validate configuration URL (only allow absolute paths for security)
		function validateConfigUrl(url) {
			if (!url) {
				throw new Error('No configuration URL provided');
			}

			// Security check: only allow absolute paths, no external URLs for security
			if (url.startsWith('http://') || url.startsWith('https://')) {
				// Allow same-origin URLs only
				const currentOrigin = window.location.origin;
				const urlObj = new URL(url);
				if (urlObj.origin !== currentOrigin) {
					throw new Error('External configuration URLs are not allowed for security reasons');
				}
			}

			// Ensure the URL ends with .json or .json5
			if (!url.match(/\.(json5?|JSON5?)(\?.*)?$/)) {
				throw new Error('Configuration must be a JSON or JSON5 file');
			}

			return url;
		}

		// Fetch configuration with error handling
		async function fetchConfiguration(url) {
			try {
				const response = await fetch(url);

				if (!response.ok) {
					throw new Error(`HTTP ${response.status}: ${response.statusText}`);
				}

				const contentType = response.headers.get('content-type');
				if (!contentType || !contentType.includes('application/json')) {
					console.warn('Configuration file does not have JSON content-type');
				}

				const configText = await response.text();

				// Try to parse as JSON5 first, then JSON
				let config;
				try {
					// If JSON5 library is available, use it
					if (window.JSON5) {
						config = JSON5.parse(configText);
					} else {
						config = JSON.parse(configText);
					}
				} catch (parseError) {
					throw new Error(`Invalid JSON format: ${parseError.message}`);
				}

				// Validate configuration structure
				if (!config || typeof config !== 'object') {
					throw new Error('Configuration must be a valid JSON object');
				}

				return config;

			} catch (error) {
				if (error.name === 'TypeError' && error.message.includes('fetch')) {
					throw new Error(`Network error: Unable to fetch configuration. Check the URL and CORS settings.`);
				}
				throw error;
			}
		}

		// Initialize Potree viewer
		function initializeViewer() {
			window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

			// Set default viewer settings
			viewer.setEDLEnabled(true);
			viewer.setFOV(60);
			viewer.setPointBudget(1_000_000);
			viewer.loadSettingsFromURL();
			viewer.setBackground("gradient");

			return viewer.loadGUI().then(() => {
				viewer.setLanguage('en');
				$("#menu_tools").next().show();
				$("#menu_clipping").next().show();
				viewer.toggleSidebar();
			});
		}

		// Load configuration directly from CKAN data
		async function loadConfigurationFromCKAN(sceneData) {
			try {
				showLoading();

				if (!sceneData) {
					throw new Error('No scene data provided from CKAN');
				}

				// Initialize viewer if not already done
				if (!window.viewer) {
					await initializeViewer();
				}

				// Apply configuration directly
				await applySceneConfiguration(sceneData);

				hideLoading();
				hideError();

				if (urlParams.debug) {
					console.log('CKAN scene data loaded successfully:', sceneData);
				}

			} catch (error) {
				console.error('CKAN configuration loading error:', error);
				showError(
					'CKAN Configuration Loading Failed',
					error.message,
					`Scene data: ${JSON.stringify(sceneData, null, 2)}\nError: ${error.stack || error.message}`
				);
			}
		}

		// Apply scene configuration to viewer
		async function applySceneConfiguration(config) {
			try {
				// Set description if available
				if (config.description) {
					viewer.setDescription(config.description);
				}

				// Load point clouds if available
				if (config.pointclouds && config.pointclouds.length > 0) {
					for (const pointCloudConfig of config.pointclouds) {
						await loadPointCloudFromConfig(pointCloudConfig);
					}
				}

				// Apply camera settings if available
				if (config.camera) {
					applyCameraSettings(config.camera);
				}

				// Apply viewer settings if available
				if (config.settings) {
					applyViewerSettings(config.settings);
				}

			} catch (error) {
				console.error('Error applying scene configuration:', error);
				throw error;
			}
		}

		// Load point cloud from configuration
		async function loadPointCloudFromConfig(pointCloudConfig) {
			return new Promise((resolve, reject) => {
				const url = pointCloudConfig.url || pointCloudConfig.path;
				const name = pointCloudConfig.name || 'pointcloud';

				Potree.loadPointCloud(url, name, e => {
					try {
						let scene = viewer.scene;
						let pointcloud = e.pointcloud;

						let material = pointcloud.material;
						material.size = pointCloudConfig.pointSize || 1;
						material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
						material.shape = Potree.PointShape.SQUARE;

						// Apply material settings if available
						if (pointCloudConfig.material) {
							Object.assign(material, pointCloudConfig.material);
						}

						scene.addPointCloud(pointcloud);

						// Apply transformation if available
						if (pointCloudConfig.position) {
							pointcloud.position.set(...pointCloudConfig.position);
						}
						if (pointCloudConfig.rotation) {
							pointcloud.rotation.set(...pointCloudConfig.rotation);
						}
						if (pointCloudConfig.scale) {
							pointcloud.scale.set(...pointCloudConfig.scale);
						}

						viewer.fitToScreen();
						resolve();
					} catch (error) {
						reject(error);
					}
				});
			});
		}

		// Apply camera settings
		function applyCameraSettings(cameraConfig) {
			if (cameraConfig.position) {
				viewer.scene.getActiveCamera().position.set(...cameraConfig.position);
			}
			if (cameraConfig.target) {
				viewer.scene.view.lookAt(...cameraConfig.target);
			}
		}

		// Apply viewer settings
		function applyViewerSettings(settings) {
			if (settings.pointBudget) {
				viewer.setPointBudget(settings.pointBudget);
			}
			if (settings.fov) {
				viewer.setFOV(settings.fov);
			}
			if (settings.background) {
				viewer.setBackground(settings.background);
			}
		}

		// Load configuration and apply to viewer
		async function loadConfigurationFromURL(configUrl) {
			try {
				showLoading();

				// Validate URL
				const validatedUrl = validateConfigUrl(configUrl);

				// Fetch configuration
				const config = await fetchConfiguration(validatedUrl);

				// Initialize viewer if not already done
				if (!window.viewer) {
					await initializeViewer();
				}

				// Load the project configuration
				await viewer.loadProject(validatedUrl);

				hideLoading();
				hideError();

				if (urlParams.debug) {
					console.log('Configuration loaded successfully:', config);
				}

			} catch (error) {
				console.error('Configuration loading error:', error);
				showError(
					'Configuration Loading Failed',
					error.message,
					`URL: ${configUrl}\nError: ${error.stack || error.message}`
				);
			}
		}

		// Load default fallback view
		async function loadDefaultView() {
			try {
				hideError();
				showLoading();

				// Initialize viewer if not already done
				if (!window.viewer) {
					await initializeViewer();
				}

				// Set default description
				viewer.setDescription("Potree Viewer - Default view loaded due to configuration error");

				// Load default point cloud (if available)
				try {
					await new Promise((resolve, reject) => {
						Potree.loadPointCloud("./pointclouds/vol_total/cloud.js", "default", e => {
							let scene = viewer.scene;
							let pointcloud = e.pointcloud;

							let material = pointcloud.material;
							material.size = 1;
							material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
							material.shape = Potree.PointShape.SQUARE;

							scene.addPointCloud(pointcloud);
							viewer.fitToScreen();
							resolve();
						});
					});
				} catch (pointCloudError) {
					console.warn('Default point cloud not available:', pointCloudError);
				}

				hideLoading();

			} catch (error) {
				console.error('Failed to load default view:', error);
				showError('Initialization Failed', 'Unable to initialize the viewer', error.message);
			}
		}

		// Retry loading configuration
		window.retryConfiguration = function() {
			if (urlParams && urlParams.ckanData) {
				loadConfigurationFromCKAN(urlParams.ckanData);
			} else if (configUrl) {
				loadConfigurationFromURL(configUrl);
			} else {
				loadDefaultView();
			}
		};

		// Load default view (global function for button)
		window.loadDefaultView = loadDefaultView;

		// Report issue (opens GitHub issues page)
		window.reportIssue = function() {
			const issueUrl = 'https://github.com/mosoriob/potree/issues/new';
			const title = encodeURIComponent('Configuration Loading Error');
			const body = encodeURIComponent(`Configuration URL: ${configUrl || 'N/A'}\nError: Configuration failed to load\nBrowser: ${navigator.userAgent}`);
			window.open(`${issueUrl}?title=${title}&body=${body}`, '_blank');
		};

		// Show save notification
		function showSaveNotification(message, type = 'success', duration = 4000) {
			// Remove existing notifications
			const existingNotifications = document.querySelectorAll('.save-notification');
			existingNotifications.forEach(n => n.remove());

			// Create notification element
			const notification = document.createElement('div');
			notification.className = `save-notification save-${type}`;
			notification.innerHTML = message;

			// Add to DOM
			document.body.appendChild(notification);

			// Auto-remove after duration
			setTimeout(() => {
				if (notification.parentElement) {
					notification.style.opacity = '0';
					setTimeout(() => notification.remove(), 300);
				}
			}, duration);
		}

		// Save scene data back to CKAN
		async function saveSceneData() {
			if (!window.viewer) {
				showSaveNotification('❌ Viewer not initialized', 'error');
				return;
			}

			const resourceData = window.ckanResourceData;
			if (!resourceData || !resourceData.id) {
				showSaveNotification('❌ No resource information available', 'error');
				return;
			}

			try {
				// Disable save button and show progress
				const saveBtn = document.getElementById('save-scene-btn');
				const originalText = saveBtn.innerHTML;
				saveBtn.disabled = true;
				saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Saving...';

				showSaveNotification('💾 Saving scene data...', 'progress', 2000);

				// Check if scene has point clouds
				if (!viewer.scene.pointclouds || viewer.scene.pointclouds.length === 0) {
					throw new Error('No point clouds loaded in scene. Cannot save project without point cloud data.');
				}

				// Debug: Log point cloud info
				console.log('Point clouds in scene:', viewer.scene.pointclouds.length);
				viewer.scene.pointclouds.forEach((pc, i) => {
					console.log(`Point cloud ${i}:`, {
						name: pc.name,
						visible: pc.visible,
						pcoGeometry: !!pc.pcoGeometry,
						url: pc.pcoGeometry?.url
					});
				});

				// Get current scene data using Potree's saveProject (exactly like sidebar export)
				let data = viewer.saveProject()
				let dataString = JSON5.stringify(data, null, "\t");

				// Send to backend
				const response = await fetch(`/dataset/potree/${resourceData.id}/save`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
					},
					body: `content=${encodeURIComponent(dataString)}`
				});

				if (response.ok) {
					const result = await response.json();
					if (result.success) {
						showSaveNotification('✅ Scene saved successfully!', 'success');
					} else {
						throw new Error(result.error || 'Unknown error occurred');
					}
				} else {
					const errorText = await response.text();
					throw new Error(`HTTP ${response.status}: ${errorText}`);
				}

			} catch (error) {
				console.error('Save error:', error);
				showSaveNotification(`❌ Save failed: ${error.message}`, 'error', 6000);
			} finally {
				// Re-enable save button
				const saveBtn = document.getElementById('save-scene-btn');
				if (saveBtn) {
					saveBtn.disabled = false;
					saveBtn.innerHTML = originalText;
				}
			}
		}

		// Initialize save controls
		function initializeSaveControls() {
			const saveControls = document.getElementById('save-controls');
			const saveBtn = document.getElementById('save-scene-btn');

			if (saveControls && saveBtn) {
				// Show save controls if we have a resource
				if (window.ckanResourceData && window.ckanResourceData.id) {
					saveControls.style.display = 'block';
				}

				// Attach save event
				saveBtn.addEventListener('click', saveSceneData);
			}
		}

		// Main initialization
		async function main() {
			try {
				// Parse parameters (both CKAN and URL)
				urlParams = parseParameters();

				if (urlParams.debug) {
					console.log('Parameters:', urlParams);
				}

				// Priority 1: Use CKAN scene data if available
				if (urlParams.ckanData) {
					await loadConfigurationFromCKAN(urlParams.ckanData);
				}
				// Priority 2: Use URL config parameter
				else if (urlParams.config) {
					configUrl = urlParams.config;
					await loadConfigurationFromURL(configUrl);
				}
				// Priority 3: Direct point cloud loading (legacy support)
				else if (urlParams.pointcloud) {
					await initializeViewer();
					viewer.setDescription("Potree Viewer - Direct point cloud loading");

					Potree.loadPointCloud(urlParams.pointcloud, "pointcloud", e => {
						let scene = viewer.scene;
						let pointcloud = e.pointcloud;

						let material = pointcloud.material;
						material.size = 1;
						material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
						material.shape = Potree.PointShape.SQUARE;

						scene.addPointCloud(pointcloud);
						viewer.fitToScreen();
					});
				}
				// Priority 4: Show instructions and resource info
				else {
					await initializeViewer();
					const resourceInfo = urlParams.resourceData;
					const hasResource = resourceInfo && resourceInfo.id;

					viewer.setDescription(`
						<h3>Potree Viewer - CKAN Integration</h3>
						${hasResource ? `
							<div class="resource-info">
								<h4>Resource Information</h4>
								<p><strong>Name:</strong> ${resourceInfo.name}</p>
								<p><strong>Format:</strong> ${resourceInfo.format}</p>
								<p><strong>ID:</strong> ${resourceInfo.id}</p>
							</div>
						` : ''}
						<div class="usage-info">
							<h4>Usage</h4>
							<p>This viewer supports multiple loading methods:</p>
							<ul>
								<li><strong>CKAN Integration:</strong> Scene data passed via template variables</li>
								<li><strong>URL Config:</strong> <code>?config=path/to/config.json5</code></li>
								<li><strong>Direct Loading:</strong> <code>?pointcloud=path/to/cloud.js</code></li>
								<li><strong>Debug Mode:</strong> <code>?debug=true</code></li>
							</ul>
						</div>
						${!hasResource && !urlParams.ckanData ? `
							<div class="alert alert-info">
								<strong>Note:</strong> No scene data was provided. This viewer is designed to work
								with CKAN resources containing Potree scene configurations.
							</div>
						` : ''}
					`);
				}

				// Initialize save controls after everything is loaded
				initializeSaveControls();

			} catch (error) {
				console.error('Initialization error:', error);
				showError('Initialization Error', error.message, error.stack);
			}
		}

		// Start the application
		main();

	</script>
</body>
</html>