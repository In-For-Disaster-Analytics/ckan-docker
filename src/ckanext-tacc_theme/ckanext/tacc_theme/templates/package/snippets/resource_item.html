{#
  Renders a single resource with icons and view links.

  res - A resource dict to render
  pkg - A package dict that the resource belongs to
  can_edit - Whether the user is allowed to edit the resource
  url_is_edit - Whether the link to the resource should be to editing it (set to False to make the link view the resource)
  is_activity_archive - Whether this is an old version of the dataset (and therefore read-only)

  Example:

    {% snippet "package/snippets/resource_item.html", res=resource, pkg_dict=pkg_dict, can_edit=True, url_is_edit=False %}

#}

{% set url_action = pkg.type ~ ('_resource.edit' if url_is_edit and can_edit else '_resource.read') %}
{% set url = h.url_for(url_action, id=pkg.id if is_activity_archive else pkg.name, resource_id=res.id, **({'activity_id': request.args['activity_id']} if 'activity_id' in request.args else {})) %}

<li class="resource-item" data-id="{{ res.id }}">
  {% block resource_item_title %}
  <a class="heading" href="{{ url }}" title="{{ res.name or res.description }}">
    {{ h.resource_display_name(res) | truncate(50) }}<span class="format-label" property="dc:format" data-format="{{ res.format.lower() or 'data' }}">{{ h.get_translated(res, 'format') }}</span>
    {{ h.popular('views', res.tracking_summary.total, min=10) if res.tracking_summary }}
  </a>
  {% endblock %}

  {% block resource_item_description %}
    <p class="description">
      {% if res.description %}
        {{ h.markdown_extract(h.get_translated(res, 'description'), extract_length=80) }}
      {% endif %}
    </p>
  {% endblock %}

  {% block resource_item_explore %}
  {% if not url_is_edit %}
  <div class="dropdown btn-group">
    <a href="#" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
      <i class="fa fa-share"></i>
      {{ _('Explore') }}
      <span class="caret"></span>
    </a>
    <ul class="dropdown-menu">
      {% block resource_item_explore_links %}
      <li>
        <a href="{{ url }}">
          {% if not is_activity_archive and res.has_views %}
            <i class="fa fa-bar-chart-o"></i>
            {{ _('Preview') }}
          {% else %}
            <i class="fa fa-info-circle"></i>
            {{ _('More information') }}
          {% endif %}
        </a>
      </li>
      {% if res.url and h.is_url(res.url) %}
      <li>
        <a href="{{ res.url }}" class="resource-url-analytics" target="_blank">
          {% if res.has_views or res.url_type == 'upload' %}
            <i class="fa fa-arrow-circle-o-down"></i>
            {{ _('Download') }}
          {% else %}
            <i class="fa fa-external-link"></i>
            {{ _('Go to resource') }}
          {% endif %}
        </a>
      </li>
      {% endif %}

      <!-- NEW: MINT Analysis Option -->
      <li class="divider"></li>
      <li>
        <a href="#" onclick="openMintAnalysis('{{ res.id }}', '{{ res.name }}', '{{ res.format }}', '{{ pkg.name }}', '{{ pkg.title }}'); return false;">
          <i class="fa fa-flask"></i>
          {{ _('Analyze on CKAN') }}
        </a>
      </li>

      {% if can_edit %}
      <li class="divider"></li>
      <li>
        <a href="{{ h.url_for(pkg.type ~ '_resource.edit', id=pkg.name, resource_id=res.id) }}">
          <i class="fa fa-pencil-square-o"></i>
          {{ _('Edit') }}
        </a>
      </li>
      {% endif %}
      {% endblock %}
    </ul>
  </div>
  {% endif %}
  {% endblock %}
</li>

<!-- MINT Analysis Modal -->
<div id="mintAnalysisModal" class="mint-modal">
    <div class="mint-modal-content">
        <div class="mint-modal-header">
            <div class="mint-modal-title">üî¨ MINT Analysis</div>
            <span class="mint-close" onclick="closeMintAnalysis()">&times;</span>
        </div>
        <div class="mint-modal-body">
            <div id="resourceInfo" class="resource-info">
                <!-- Resource information will be populated here -->
            </div>

            <h4 style="margin-bottom: 20px; color: #333;">Choose Analysis Type:</h4>

            <div id="analysisOptions" class="analysis-grid">
                <div class="analysis-card" onclick="performMintAnalysis('bibliometric')">
                    <div class="analysis-icon">üìö</div>
                    <h5>Bibliometric Analysis</h5>
                    <p>Analyze citation patterns, co-authorship networks, and research trends</p>
                </div>

                <div class="analysis-card" onclick="performMintAnalysis('textmining')">
                    <div class="analysis-icon">üî§</div>
                    <h5>Text Mining</h5>
                    <p>Extract keywords, topics, and semantic analysis</p>
                </div>

                <div class="analysis-card" onclick="performMintAnalysis('network')">
                    <div class="analysis-icon">üï∏Ô∏è</div>
                    <h5>Network Analysis</h5>
                    <p>Visualize relationships and connections in data</p>
                </div>

                <div class="analysis-card" onclick="performMintAnalysis('temporal')">
                    <div class="analysis-icon">üìà</div>
                    <h5>Temporal Analysis</h5>
                    <p>Analyze trends and patterns over time</p>
                </div>

                <div class="analysis-card" onclick="performMintAnalysis('workflow')">
                    <div class="analysis-icon">üîó</div>
                    <h5>MINT Workflow</h5>
                    <p>Integrate with MINT modeling workflows</p>
                </div>

                <div class="analysis-card" onclick="performMintAnalysis('export')">
                    <div class="analysis-icon">üìä</div>
                    <h5>Export & Visualize</h5>
                    <p>Export processed data and create visualizations</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <a href="#" class="mint-btn" onclick="closeMintAnalysis()">Close</a>
            </div>
        </div>
    </div>
</div>

<script>
let currentResourceData = null;

function openMintAnalysis(resourceId, resourceName, resourceFormat, packageId, packageTitle) {
    currentResourceData = {
        id: resourceId,
        name: resourceName,
        format: resourceFormat,
        package: packageId,
        packageTitle: packageTitle
    };

    // Update resource info in modal
    document.getElementById('resourceInfo').innerHTML = `
        <h5 style="margin-bottom: 10px; color: #333;">üìÑ Resource: ${resourceName}</h5>
        <p><strong>Format:</strong> ${resourceFormat}</p>
        <p><strong>Package Id:</strong> ${packageId}</p>
        <p><strong>Package Title:</strong> ${packageTitle}</p>
        <p><strong>Resource ID:</strong> ${resourceId}</p>
    `;

    // Show modal
    document.getElementById('mintAnalysisModal').style.display = 'block';

    // Close any open dropdowns
    $('.dropdown').removeClass('open');
}

function closeMintAnalysis() {
    document.getElementById('mintAnalysisModal').style.display = 'none';
    currentResourceData = null;
    resetAnalysisOptions();
}

function performMintAnalysis(analysisType) {
    if (!currentResourceData) return;

    const optionsContainer = document.getElementById('analysisOptions');
    let message = '';
    let action = '';

    switch(analysisType) {
        case 'bibliometric':
            message = 'Starting bibliometric analysis...';
            action = 'Analyzing citation patterns and research networks from the data.';
            break;
        case 'textmining':
            message = 'Initiating text mining analysis...';
            action = 'Extracting keywords and performing semantic analysis.';
            break;
        case 'network':
            message = 'Building network analysis...';
            action = 'Creating relationship and connection visualizations.';
            break;
        case 'temporal':
            message = 'Performing temporal analysis...';
            action = 'Analyzing trends and patterns over time.';
            break;
        case 'workflow':
            message = 'Integrating with MINT workflow...';
            action = 'Preparing data for MINT modeling workflows.';
            break;
        case 'export':
            message = 'Preparing export and visualizations...';
            action = 'Processing data for export and creating visualizations.';
            break;
    }

    // Show loading state
    optionsContainer.innerHTML = `
        <div class="mint-loading">
            <div class="mint-spinner"></div>
            <p>${message}</p>
            <small style="color: #666; display: block; margin-top: 10px;">${action}</small>
        </div>
    `;

    // Simulate processing
    setTimeout(() => {
        showAnalysisResult(analysisType);
    }, 2000);
}

function showAnalysisResult(analysisType) {
    const optionsContainer = document.getElementById('analysisOptions');
    let resultContent = '';

    switch(analysisType) {
        case 'bibliometric':
            resultContent = `
                <div class="mint-success">‚úÖ Bibliometric Analysis Complete!</div>
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                    <h4>Analysis Results for ${currentResourceData.name}:</h4>
                    <ul style="margin: 15px 0; padding-left: 20px; color: #666;">
                        <li>Publications analyzed: 1,247</li>
                        <li>Unique authors: 342</li>
                        <li>Citation networks: 1,845 nodes</li>
                        <li>Research clusters: 8</li>
                    </ul>
                    <a href="#" class="mint-btn" onclick="alert('Opening analysis report...')">üìä View Full Report</a>
                    <a href="#" class="mint-btn" onclick="alert('Downloading results...')">üíæ Download Results</a>
                </div>
            `;
            break;
        case 'workflow':
            resultContent = `
                <div class="mint-success">‚úÖ MINT Integration Ready!</div>
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                    <h4>Integration Options:</h4>
                    <p>Your dataset <strong>${currentResourceData.name}</strong> is ready for MINT workflows.</p>
                    <a href="#" class="mint-btn" onclick="alert('Redirecting to MINT workflow...')">üöÄ Start MINT Workflow</a>
                    <a href="#" class="mint-btn" onclick="alert('Adding to data catalog...')">üìã Add to Data Catalog</a>
                </div>
            `;
            break;
        default:
            resultContent = `
                <div class="mint-success">‚úÖ Analysis Complete!</div>
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                    <p>Your ${analysisType} analysis for <strong>${currentResourceData.name}</strong> has been completed.</p>
                    <a href="#" class="mint-btn" onclick="alert('Opening results...')">üìä View Results</a>
                </div>
            `;
    }

    resultContent += `
        <div style="text-align: center; margin-top: 20px;">
            <a href="#" class="mint-btn" onclick="resetAnalysisOptions()" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d);">
                ‚Üê Back to Options
            </a>
        </div>
    `;

    optionsContainer.innerHTML = resultContent;
}

function resetAnalysisOptions() {
    document.getElementById('analysisOptions').innerHTML = `
        <div class="analysis-card" onclick="performMintAnalysis('bibliometric')">
            <div class="analysis-icon">üìö</div>
            <h5>Bibliometric Analysis</h5>
            <p>Analyze citation patterns, co-authorship networks, and research trends</p>
        </div>

        <div class="analysis-card" onclick="performMintAnalysis('textmining')">
            <div class="analysis-icon">üî§</div>
            <h5>Text Mining</h5>
            <p>Extract keywords, topics, and semantic analysis</p>
        </div>

        <div class="analysis-card" onclick="performMintAnalysis('network')">
            <div class="analysis-icon">üï∏Ô∏è</div>
            <h5>Network Analysis</h5>
            <p>Visualize relationships and connections in data</p>
        </div>

        <div class="analysis-card" onclick="performMintAnalysis('temporal')">
            <div class="analysis-icon">üìà</div>
            <h5>Temporal Analysis</h5>
            <p>Analyze trends and patterns over time</p>
        </div>

        <div class="analysis-card" onclick="performMintAnalysis('workflow')">
            <div class="analysis-icon">üîó</div>
            <h5>MINT Workflow</h5>
            <p>Integrate with MINT modeling workflows</p>
        </div>

        <div class="analysis-card" onclick="performMintAnalysis('export')">
            <div class="analysis-icon">üìä</div>
            <h5>Export & Visualize</h5>
            <p>Export processed data and create visualizations</p>
        </div>
    `;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('mintAnalysisModal');
    if (event.target === modal) {
        closeMintAnalysis();
    }
}
</script>